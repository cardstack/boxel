name: Preview Deployment Comment

on:
  workflow_call:
    inputs:
      pr-number:
        description: Pull request number to comment on
        required: true
        type: number
      head-sha:
        description: Commit SHA that produced the preview
        required: true
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  publish-preview-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Gather preview links
        id: gather
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          HEAD_SHA: ${{ inputs.head-sha }}
        run: |
          set -euo pipefail

          statuses="$(
            curl -sf \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPOSITORY/statuses/$HEAD_SHA"
          )"

          # These check names are inputs to deploy-ember-preview action
          host_staging="$(echo "$statuses" | jq -r 'map(select(.context == "Preview boxel-host staging")) | .[0].target_url // empty')"
          host_production="$(echo "$statuses" | jq -r 'map(select(.context == "Preview boxel-host production")) | .[0].target_url // empty')"
          ui_staging="$(echo "$statuses" | jq -r 'map(select(.context == "Preview boxel-ui staging")) | .[0].target_url // empty')"

          if [ -z "$host_staging$host_production$ui_staging" ]; then
            echo "empty=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {
            echo "message<<EOF"
            echo "### Preview deployments"
            echo
            if [ -n "$host_staging" ]; then
              echo "- [Host staging preview]($host_staging)"
            fi
            if [ -n "$host_production" ]; then
              echo "- [Host production preview]($host_production)"
            fi
            if [ -n "$ui_staging" ]; then
              echo "- [Boxel UI staging preview]($ui_staging)"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Post preview links comment
        if: steps.gather.outputs.empty != 'true'
        uses: marocchino/sticky-pull-request-comment@5060d4700a91de252c87eeddd2da026382d9298a # 2.9.4
        with:
          header: preview-deployments
          number: ${{ inputs.pr-number }}
          message: ${{ steps.gather.outputs.message }}
