name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  checks: write
  contents: read
  id-token: write
  pull-requests: write

jobs:
  change-check:
    name: Check which packages changed
    runs-on: ubuntu-latest
    outputs:
      boxel: ${{ steps.filter.outputs.boxel }}
      ai-bot: ${{ steps.filter.outputs.ai-bot }}
      boxel-icons: ${{ steps.filter.outputs.boxel-icons }}
      boxel-motion: ${{ steps.filter.outputs.boxel-motion }}
      boxel-ui: ${{ steps.filter.outputs.boxel-ui }}
      matrix: ${{ steps.filter.outputs.matrix }}
      realm-server: ${{ steps.filter.outputs.realm-server }}
      vscode-boxel-tools: ${{ steps.filter.outputs.vscode-boxel-tools }}
      workspace-sync-cli: ${{ steps.filter.outputs.workspace-sync-cli }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # 4.2.2
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # 3.0.2
        id: filter
        with:
          filters: |
            shared: &shared
              - '.github/workflows/ci.yaml'
              - 'packages/runtime-common/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            boxel:
              - *shared
              - '.github/workflows/build-host.yml'
              - '.github/workflows/deploy-host.yml'
              - '.github/workflows/manual-deploy.yml'
              - 'packages/ai-bot/**'
              - 'packages/base/**'
              - 'packages/boxel-icons/**'
              - 'packages/boxel-ui/**'
              - 'packages/host/**'
              - 'packages/realm-server/**'
            ai-bot:
              - *shared
              - '.github/workflows/pr-ai-bot.yml'
              - 'packages/ai-bot/**'
              - 'packages/billing/**'
              - 'packages/postgres/**'
            boxel-icons:
              - *shared
              - 'packages/boxel-icons/**'
            boxel-motion:
              - *shared
              - 'packages/boxel-motion/**'
            boxel-ui:
              - *shared
              - 'packages/boxel-icons/**'
              - 'packages/boxel-ui/**'
            matrix:
              - *shared
              - 'packages/base/**'
              - 'packages/boxel-icons/**'
              - 'packages/boxel-ui/**'
              - 'packages/host/**'
              - 'packages/matrix/**'
              - 'packages/realm-server/**'
            realm-server:
              - *shared
              - 'packages/billing/**'
              - 'packages/boxel-icons/**'
              - 'packages/boxel-ui/**'
              - 'packages/eslint-plugin-boxel/**'
              - 'packages/postgres/**'
              - 'packages/realm-server/**'
            vscode-boxel-tools:
              - *shared
              - 'packages/vscode-boxel-tools/**'
            workspace-sync-cli:
              - *shared
              - 'packages/workspace-sync-cli/**'

  matrix-client-test:
    name: Matrix Client Tests
    needs: change-check
    if: needs.change-check.outputs.matrix == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [12]
        shardTotal: [12]
    concurrency:
      group: matrix-client-test-${{ matrix.shardIndex }}-${{ github.head_ref || github.run_id }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # 4.2.2
      - uses: ./.github/actions/init
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps
        working-directory: packages/matrix
      - name: Build boxel-icons
        run: pnpm build
        working-directory: packages/boxel-icons
      - name: Serve boxel-icons
        run: pnpm serve &
        working-directory: packages/boxel-icons
      - name: Build boxel-ui
        run: pnpm build
        working-directory: packages/boxel-ui/addon
      - name: Build boxel-motion
        run: pnpm build
        working-directory: packages/boxel-motion/addon
      - name: Start host to serve assets for fastboot
        uses: JarvusInnovations/background-action@2428e7b970a846423095c79d43f759abf979a635 # 1.0.7
        with:
          run: NODE_OPTIONS="--max_old_space_size=4096" pnpm start &
          working-directory: packages/host
          wait-for: 3m
          wait-on: http-get://localhost:4200
      - name: Start realm servers
        run: MATRIX_REGISTRATION_SHARED_SECRET='xxxx' pnpm start:services-for-matrix-tests | tee -a /tmp/server.log &
        working-directory: packages/realm-server
      - name: Run Playwright tests
        run: pnpm test:group ${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
        working-directory: packages/matrix
      - name: Upload realm server log
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # 4.6.1
        if: always()
        with:
          name: matrix-test-realm-server-log-${{ matrix.shardIndex }}
          path: /tmp/server.log
          retention-days: 30

      - name: Upload blob report to GitHub Actions Artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # 4.6.1
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: packages/matrix/blob-report
          retention-days: 1

      - name: Upload Playwright traces
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # 4.6.1
        with:
          name: playwright-traces-${{ matrix.shardIndex }}
          path: packages/matrix/test-results/**/trace.zip
          retention-days: 30
          if-no-files-found: ignore
